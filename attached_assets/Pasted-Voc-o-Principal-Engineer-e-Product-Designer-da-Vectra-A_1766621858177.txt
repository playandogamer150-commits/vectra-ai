VocÃª Ã© o Principal Engineer e Product Designer da Vectra AI. Atualmente, usuÃ¡rios do plano gratuito conseguem gerar imagens ilimitadas com o modelo â€œrealistic-vision-51â€, e os filtros jÃ¡ foram parcialmente corrigidos. Agora precisamos **implementar uma regra de quota e roteamento de modelos por plano**, de modo que:

- **Plano Free**:
  - Pode gerar **atÃ© 5 imagens** usando o **modelo Nano Banana Pro** (ultra-realista).
  - ApÃ³s esgotar essas 5, pode gerar **atÃ© 10 imagens adicionais** usando o **modelo realistic-vision-51**.
  - ApÃ³s 15 imagens no total (5 + 10), bloqueia novas geraÃ§Ãµes atÃ© a renovaÃ§Ã£o ou upgrade para o Pro.

- **Planos pagos** permanecem com limitaÃ§Ãµes definidas anteriormente (ilimitado ou quotas prÃ³prias).

ğŸ¯ **Objetivo**: Controlar e exibir quotas de imagens ultra e standard, selecionar o modelo correto conforme quotas restantes e fornecer feedback ao usuÃ¡rio.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Banco de Dados / Modelos
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1.1 **Estenda a tabela `usage_logs` (ou similar) para controlar quotas por tipo**:
   - Colunas sugeridas: `high_quality_images_used` (int), `standard_images_used` (int), `date` (date), `user_id`.
   - Zere ou renove esses contadores conforme a polÃ­tica (dia, semana ou mÃªs). Para inÃ­cio, zere diariamente.

1.2 **Atualize os mÃ©todos do repositÃ³rio** (`getUsageByUserId`, `incrementUsage`, etc.) para lidar com dois contadores.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2. Backend â€“ LÃ³gica de GeraÃ§Ã£o
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2.1 **FunÃ§Ã£o de verificaÃ§Ã£o de quota**:
   - Ao receber `/api/generate` (para imagens):
     1. Recupere o usage atual do usuÃ¡rio.
     2. Se `high_quality_images_used < 5` â†’ selecione `model_id = "nano-banana-pro"` e incremente `high_quality_images_used`.
     3. SenÃ£o se `standard_images_used < 10` â†’ selecione `model_id = "realistic-vision-51"` e incremente `standard_images_used`.
     4. SenÃ£o â†’ retorne 402 / 429 com mensagem: â€œLimite diÃ¡rio do plano gratuito atingido. FaÃ§a upgrade para continuarâ€.

2.2 **Persistir o modelo usado**:
   - Salve `model_id` no campo `metadata` da geraÃ§Ã£o e em `usage_logs` para auditoria.

2.3 **Webhook de renovaÃ§Ã£o** (opcional):
   - Crie job diÃ¡rio (cron) para resetar contadores Ã  meia-noite do fuso do usuÃ¡rio (`America/Sao_Paulo`).

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3. Frontend â€“ Feedback ao UsuÃ¡rio
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3.1 **Mostre quotas no UI**:
   - No canto superior (onde jÃ¡ existe â€œLIMITES DIÃRIOSâ€), adicione campos:
     - `Imagens Ultra: x/5`
     - `Imagens Standard: y/10`
   - Atualize essa informaÃ§Ã£o apÃ³s cada geraÃ§Ã£o.

3.2 **Mensagens claras**:
   - Quando faltarem quotas Ultra: â€œVocÃª esgotou suas 5 imagens de alta qualidade. As prÃ³ximas 10 utilizaÃ§Ãµes usarÃ£o um modelo standard.â€
   - Quando atingir 15 geraÃ§Ãµes totais: â€œLimite diÃ¡rio do plano Free atingido. Por favor, atualize para Pro para continuar gerando imagens.â€

3.3 **Bloqueio de botÃ£o**:
   - Desabilite â€œGerar Imagemâ€ e exiba tooltip com a mensagem acima se quota esgotada.

3.4 **Upgrade CTA**:
   - Adicione botÃ£o â€œUpgrade to Proâ€ ao lado da mensagem de limite atingido, redirecionando para `/pricing`.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4. Testes
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4.1 **Unit tests** (backend):
   - Verificar que o primeiro atÃ© quinto request usa `nano-banana-pro`, o sexto atÃ© dÃ©cimo quinto usa `realistic-vision-51`, e o 16Âº resulta em erro.

4.2 **E2E tests** (frontend):
   - Simular usuÃ¡rio Free fazendo 6 geraÃ§Ãµes e confirmar que a 6Âª usa RealisticVision51.
   - Simular 15 geraÃ§Ãµes e confirmar que o botÃ£o de gerar desativa com mensagem.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
5. CritÃ©rios de Aceite
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ” UsuÃ¡rios do plano Free podem gerar no mÃ¡ximo 15 imagens/dia (5 ultra + 10 standard).  
âœ” O modelo selecionado Ã© automÃ¡tico com base nas quotas.  
âœ” As quotas sÃ£o persistidas e renovadas diariamente.  
âœ” A UI mostra claramente quantas imagens restam de cada tipo e oferece CTA para upgrade quando limites sÃ£o atingidos.  
âœ” NÃ£o hÃ¡ regressÃ£o nos planos Pro/Enterprise.  

Implemente essa lÃ³gica nas camadas de back-end e front-end, garanta testes e observabilidade, e atualize as mensagens em PT/EN.
